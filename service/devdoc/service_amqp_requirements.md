# Amqp Requirements (Service SDK)
 
## Overview
Amqp provides transport functionality for applications that want to communicate with an Azure IoT Hub using the AMQP protocol. It provides an additional level of abstraction on top of the AmqpTransport class which is not specific to the device or service side (and is located in the common part of the SDK).
Based on the configuration parameters given to the constructor, the Amqp object will build the SASL-Plain URL used to communicate with the IoT Hub instance, as well as the sending and receiving endpoints, and will instantiate an AmqpTransport object to use with these parameters.

## Example usage
```js
'use strict';
var Amqp = require('./lib/amqp').Amqp;
var Message = require('./lib/message').Message;

function print(err, res) {
  if (err) console.log(err.toString());
  if (res) console.log(res.statusCode + ' ' + res.statusMessage);
}

var serviceConfig = {
  host: 'hostname',
  keyName: 'keyname' ,
  key: 'key'
};

var serviceAmqp = new Amqp(serviceConfig );

serviceAmqp.send(deviceId, new Message('hello world'), print);

serviceAmqp.getFeedbackReceiver(function (receiver) {
  receiver.on('message', function (msg) {
    receiver.complete(msg, print);
  });
  receiver.on('error', function (err) {
    print(err);
  });
});
```
## Public Interface

### Amqp() constructor
**SRS_NODE_IOTHUB_SERVICE_AMQP_16_001: [** The `Amqp` constructor shall accept a `config` object with those four properties:
- `host` – (string) the fully-qualified DNS hostname of an IoT Hub
- `hubName` - (string) the name of the IoT Hub instance (without suffix such as .azure-devices.net).
- `keyName` – (string) the name of a key that can be used to communicate with the IoT Hub instance
- `sharedAccessSignature–` (string) the key associated with the key name.**]**

### connect(done)
The `connect` method establishes a connection with the Azure IoT Hub instance.

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_019: [** The `connect` method shall call the `connect` method of the base AMQP transport and translate its result to the caller into a transport-agnostic object. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_06_001: [** `initializeCBS` shall be invoked. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_06_002: [** If `initializeCBS` is not successful then the client will remain disconnected and the callback, if provided, will be invoked with an error object. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_06_003: [** If `initializeCBS` is successful, `putToken` shall be invoked with the first parameter audience, created from the sr of the sas signature, the next parameter of the actual sas, and a callback. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_06_004: [** If `putToken` is not successful then the client will remain disconnected and the callback, if provided, will be invoked with an error object. **]**

### disconnect(done)
the `disconnect` method terminates the connection with the Azure IoT Hub instance.

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_020: [** The `disconnect` method shall call the `disconnect` method of the base AMQP transport and translate its result to the caller into a transport-agnostic object. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_021: [** The `disconnect` method shall detach the C2D messaging link if it is attached. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_022: [** The `disconnect` method shall detach the C2D feedback receiver link if it is attached. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_023: [** The `disconnect` method shall detach the file notification receiver link if it is attached. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_024: [** Any error generated by detaching a link should be passed as the single argument of the callback of the `disconnect` method. **]**

### send(deviceId, message, done)
The `send` method sends an event to the device passed as argument, using the IoT Hub configured when instantiating the Amqp object.

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_002: [** The `send` method shall construct an AMQP request using the message passed in argument as the body of the message.**]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_003: [** The message generated by the `send` method should have its “to” field set to "/devices/(uriEncode<deviceId>)/messages/devicebound".**]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_025: [** The `send` method shall connect and authenticate the transport if it is disconnected. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_026: [** The `send` method shall call its callback with an error if connecting and/or authenticating the transport fails. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_027: [** The `send` method shall attach the C2D link if necessary. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_028: [** The `send` method shall reuse the C2D link if it is already attached. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_029: [** The `send` method shall call its callback with an error if it fails to attach the C2D link. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_030: [** The `send` method shall call the `send` method of the C2D link and pass it the Amqp request that it created. **]**

### getFeedbackReceiver(done)
Gets the `AmqpReceiver` object used to subscribe to feedback messages and errors sent by devices to this IoT Hub instance.

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_013: [** The `getFeedbackReceiver` method shall request an `AmqpReceiver` object from the base AMQP transport for the `/messages/serviceBound/feedback` endpoint. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_033: [** The `getFeedbackReceiver` method shall connect and authenticate the transport if it is disconnected. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_034: [** The `getFeedbackReceiver` method shall call its callback with an error if the transport fails to connect or authenticate. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_035: [** The `getFeedbackReceiver` method shall reuse the existing feedback receiver it if has already been attached. **]**

### getFileNotificationReceiver(done)
Gets the `AmqpReceiver` object used to subscribe to file upload notifications.

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_016: [** The `getFileNotificationReceiver` method shall request an `AmqpReceiver` object from the base AMQP transport for the `/messages/serviceBound/filenotifications` endpoint. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_036: [** The `getFileNotificationReceiver` method shall connect and authenticate the transport if it is disconnected. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_037: [** The `getFileNotificationReceiver` method shall call its callback with an error if the transport fails to connect or authenticate. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_038: [** The `getFileNotificationReceiver` method shall reuse the existing feedback receiver it if has already been attached. **]**

### updateSharedAccessSignature(sharedAccessSignature, callback)

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_039: [** The `updateSharedAccessSignature` shall throw a `ReferenceError` if the `sharedAccessSignature` argument is falsy. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_031: [** The `updateSharedAccessSignature` shall trigger a `putToken` call on the base transport if it is connected. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_032: [** The `updateSharedAccessSignature` shall not establish a connection if the transport is disconnected, but should use the new shared access signature on the next manually initiated connection attempt. **]**

### All methods
**SRS_NODE_IOTHUB_SERVICE_AMQP_16_017: [** All asynchronous instance methods shall call the `done` callback with a single parameter that is derived from the standard Javascript `Error` object if the operation failed. **]**

**SRS_NODE_IOTHUB_SERVICE_AMQP_16_018: [** All asynchronous instance methods shall call the `done` callback with either no arguments or a first null argument and a second argument that is the result of the operation if the operation succeeded. **]**
